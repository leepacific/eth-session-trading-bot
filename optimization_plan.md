# 🚀 자동 최적화 시스템 계획서

## 📊 Railway 리소스 분석 및 제약

### Railway 기본 리소스:
- **CPU**: 2-4 vCPU (사용률 70% = 1.4-2.8 코어)
- **메모리**: 512MB-8GB (사용률 70% = 358MB-5.6GB)
- **디스크**: 1GB (임시 파일용)
- **네트워크**: 무제한

### 최적화 성능 예측:
```
데이터 크기: 206,319 포인트 (15분봉)
파라미터 공간: ~12개 변수
탐색 공간 크기: 10^15 조합

단계별 예상 시간:
1. 데이터 전처리: 2-3분
2. 초기 탐색 (100 샘플): 15-20분
3. 베이지안 최적화 (200 스텝): 45-60분
4. 최종 검증: 10-15분
총 예상 시간: 70-100분
```

## 🎯 최적화 목표 함수

### 복합 스코어 공식:
```python
Score = (
    0.25 * normalize(Sortino_Ratio, target=2.0) +
    0.20 * normalize(Calmar_Ratio, target=3.0) +
    0.20 * normalize(Profit_Factor, target=2.5) +
    0.15 * normalize(Win_Rate, target=0.55) +
    0.10 * normalize(SQN, target=4.0) +
    0.10 * normalize(RR_Ratio, target=2.0)
) - penalty_function(Max_DD, Min_Trades)

제약 조건:
- Min_Trades ≥ 100
- Max_Drawdown ≤ 20%
- Win_Rate ≥ 35%
- Profit_Factor ≥ 1.3
```

## 📋 최적화 파라미터 공간

### 핵심 파라미터 (12개):
```python
param_space = {
    'swing_len': [3, 4, 5, 6, 7],
    'rr_percentile': [0.1, 0.8],
    'disp_mult': [0.8, 2.0],
    'sweep_wick_mult': [0.3, 0.8],
    'atr_len': [10, 50],
    'stop_atr_mult': [0.05, 0.15],
    'target_r': [1.5, 4.0],
    'time_stop_bars': [1, 8],
    'min_volatility_rank': [0.2, 0.7],
    'session_strength': [1.0, 2.5],
    'volume_filter': [1.0, 2.0],
    'trend_filter_len': [10, 50]
}
```

## 🔄 3단계 다중해상도 최적화

### 1단계: 러프 스크리닝 (20분)
- **데이터**: 50,000 포인트 (샘플링)
- **방법**: Sobol 시퀀스 100 샘플
- **목표**: 상위 30% 후보 선별

### 2단계: 베이지안 최적화 (50분)
- **데이터**: 100,000 포인트
- **방법**: TPE + ASHA 조기중단
- **반복**: 200 스텝
- **목표**: 상위 10개 후보 선별

### 3단계: 최종 검증 (20분)
- **데이터**: 전체 206,319 포인트
- **방법**: Walk-Forward 검증
- **후보**: 상위 5개
- **목표**: 최종 파라미터 확정

## 📅 스케줄링 계획

### 실행 시간:
- **매주 일요일 한국시간 18:00** (UTC 09:00)
- **예상 소요시간**: 90분
- **완료 시간**: 한국시간 19:30

### 시간대 고려사항:
- 일요일: 시장 휴장으로 서버 부하 최소
- 18:00: 저녁 시간대로 안정적 네트워크
- 90분 소요: 월요일 시장 개장 전 완료

## 🛡️ 리소스 관리 전략

### CPU 사용률 제한 (70%):
```python
import psutil
import multiprocessing as mp

max_workers = min(
    int(psutil.cpu_count() * 0.7),
    mp.cpu_count() - 1
)
```

### 메모리 사용률 제한 (70%):
```python
import psutil

available_memory = psutil.virtual_memory().available
max_memory = int(available_memory * 0.7)

# 배치 크기 동적 조정
batch_size = min(
    default_batch_size,
    max_memory // estimated_memory_per_sample
)
```

## 📊 성능 최적화 기법

### 1. 데이터 최적화:
- **Float32 다운캐스트**: 메모리 50% 절약
- **Numba JIT 컴파일**: 속도 10-50x 향상
- **벡터화 연산**: Pandas 대신 NumPy
- **메모리 맵핑**: 대용량 데이터 효율 처리

### 2. 알고리즘 최적화:
- **ASHA 조기중단**: 불필요한 계산 80% 절약
- **베이지안 최적화**: 그리드 서치 대비 10x 효율
- **병렬 처리**: 멀티코어 활용
- **캐시 최적화**: 중복 계산 제거

### 3. 백테스트 엔진 최적화:
- **이벤트 드리븐**: 상태 변화시만 계산
- **증분 업데이트**: 전체 재계산 방지
- **배열 연산**: 루프 최소화
- **메모리 풀링**: GC 오버헤드 감소

## 🔍 과최적화 방지 전략

### 1. 교차 검증:
- **Walk-Forward**: 5개 구간 롤링 검증
- **Out-of-Sample**: 최근 20% 데이터 분리
- **Purged K-Fold**: 시계열 누수 방지

### 2. 로버스트니스 테스트:
- **파라미터 섭동**: ±10% 변화 테스트
- **거래비용 스트레스**: 2배 수수료 재검증
- **시장 레짐 변화**: 다양한 변동성 구간 테스트

### 3. 안정성 지표:
- **파라미터 민감도**: 변화율 < 20%
- **성과 일관성**: 구간별 편차 < 30%
- **드로우다운 안정성**: 최대 DD 변화 < 5%

## 📈 예상 개선 효과

### 현재 성과 vs 최적화 후:
```
현재 (기본 파라미터):
- Profit Factor: 3.03
- Win Rate: 60.8%
- 총 거래: 659개

예상 최적화 후:
- Profit Factor: 3.5-4.0 (목표)
- Win Rate: 55-65% (안정화)
- Sortino Ratio: 2.5+ (목표)
- Max DD: 15% 이하 (목표)
- SQN: 4.0+ (목표)
```

## ⚠️ 리스크 및 대응책

### 1. 시스템 리스크:
- **메모리 부족**: 배치 크기 자동 조정
- **CPU 과부하**: 워커 수 동적 제한
- **네트워크 지연**: 로컬 캐시 활용

### 2. 최적화 리스크:
- **과최적화**: 다중 검증 단계
- **데이터 편향**: 레짐 균등 샘플링
- **미래 편향**: 엄격한 시계열 분할

### 3. 운영 리스크:
- **Railway 제한**: 실행 시간 90분 내 완료
- **데이터 품질**: 이상치 자동 감지
- **파라미터 발산**: 경계 조건 강제

## 🎯 성공 기준

### 최소 달성 목표:
- **Profit Factor**: ≥ 2.5
- **Sortino Ratio**: ≥ 2.0
- **Max Drawdown**: ≤ 20%
- **최소 거래수**: ≥ 100개
- **Win Rate**: ≥ 45%

### 이상적 목표:
- **Profit Factor**: ≥ 3.5
- **Sortino Ratio**: ≥ 3.0
- **Calmar Ratio**: ≥ 4.0
- **SQN**: ≥ 4.0
- **Max Drawdown**: ≤ 15%

---

## 📋 실행 준비 체크리스트

- [ ] Railway 리소스 모니터링 설정
- [ ] 스케줄러 (APScheduler) 설정
- [ ] 최적화 엔진 구현
- [ ] 백테스트 엔진 최적화
- [ ] 결과 저장 및 알림 시스템
- [ ] 오류 처리 및 복구 로직
- [ ] 성능 모니터링 대시보드

**예상 개발 시간**: 4-6시간
**첫 실행 예정**: 다음 일요일 18:00 KST
**지속적 개선**: 매주 자동 실행